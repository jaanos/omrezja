\RequirePackage{tikz,xparse,environ,ifthen,keyval,etoolbox}
\usetikzlibrary{matrix}

\newboolean{@oznake}
\DeclareOption{oznake}{\setboolean{@oznake}{true}}
\ProcessOptions

\tikzset{odmik/.style={left/.default=#1,right/.default=#1,above/.default=#1,below/.default=#1}}

\tikzstyle{velikost}=[scale=0.7]
\tikzstyle{velikost vozlisca pretoka}=[minimum size=5mm]
\tikzstyle{velikost vozlisca neusmerjenega grafa}=[minimum size=5mm]

\ifthenelse{\boolean{@oznake}}{
    \tikzstyle{velikost vozlisca razvoza}=[minimum size=15mm]
}{
    \tikzstyle{velikost vozlisca razvoza}=[minimum size=10mm]
}

\tikzstyle{osnova}=[thick, black]

\tikzstyle{vozlisce}=[osnova, draw, circle, fill=white, inner sep=0pt]
\tikzstyle{vozlisce razvoza}=[vozlisce, velikost vozlisca razvoza]
\tikzstyle{vozlisce pretoka}=[vozlisce, velikost vozlisca pretoka]
\tikzstyle{vozlisce neusmerjenega grafa}=[vozlisce, velikost vozlisca neusmerjenega grafa]

\tikzstyle{zacetek razvoza}=[draw, black, solid, near start, rectangle, thick, fill=white, inner sep=0pt, minimum size=4mm, odmik=1mm]
\tikzstyle{konec razvoza}=[black, near end]

\tikzstyle{zacetek pretoka}=[black, near start]
\tikzstyle{konec pretoka}=[black, near end]

\tikzstyle{zacetek neusmerjenega grafa}=[black, midway]
\tikzstyle{konec neusmerjenega grafa}=[black, midway]

\tikzstyle{drevo}=[very thick, red]
\tikzstyle{izstopi}=[dashed]
\tikzstyle{vstopi}=[thick, blue]
\tikzstyle{kandidat}=[thick, green]

\tikzstyle{pot}=[very thick]
\tikzstyle{prerez}=[zasicena, double]
\tikzstyle{prazna}=[thin]
\tikzstyle{nasprotna}=[prazna, double]
\tikzstyle{dosezeno}=[white, fill=black]
\tikzstyle{pogojno}=[fill=lightgray]

\tikzstyle{mreza/velikost vozlisca razvoza}=[minimum size=5mm]
\tikzstyle{mreza/velikost vozlisca pretoka}=[minimum size=5mm]
\tikzstyle{mreza/velikost vozlisca neusmerjenega grafa}=[minimum size=3mm]
\tikzstyle{mreza/osnova}=[thin, gray]

\NewDocumentCommand{\stevec}{m}{
    \ifcsname c@#1\endcsname\else\newcounter{#1}\fi\stepcounter{#1}
}

\NewDocumentEnvironment{razvoz*}{O{{}}m}{
    \begin{tikzpicture}[velikost,#1]
        \tikzstyle{every node}=[]
        \tikzstyle{vertex}=[vozlisce razvoza]
        \tikzstyle{zacetek}=[zacetek razvoza]
        \tikzstyle{konec}=[konec razvoza]
        \tikzstyle{zasicena}=[very thick]
        \tikzstyle{povezava}=[osnova]
        \tikzstyle{kolicina}=[drevo]
        \tikzstyle{zvezdica}=[zasicena]
        \tikzstyle{puscica}=[->]
}{
        \ifthenelse{\equal{#2}{*}}{}{
            \begin{razvoz@#2}
            \end{razvoz@#2}
        }
    \end{tikzpicture}
}

\NewEnviron{razvoz}[2][{}]{
    \bigskip
    \noindent
    \makebox[\textwidth][c]{
        \stevec{#2}
        \leavevmode\beginpgfgraphicnamed{razvoz-#2-\arabic{#2}}
        \begin{razvoz*}[#1]{#2}
            \BODY
        \end{razvoz*}
        \endpgfgraphicnamed
    }
}{}

\NewDocumentEnvironment{pretok*}{O{{}}m}{
    \begin{tikzpicture}[velikost,#1]
        \tikzstyle{every node}=[]
        \tikzstyle{vertex}=[draw, circle, fill=white, inner sep=0pt, vozlisce pretoka]
        \tikzstyle{zacetek}=[zacetek pretoka]
        \tikzstyle{konec}=[konec pretoka]
        \tikzstyle{zasicena}=[dashed]
        \tikzstyle{povezava}=[osnova]
        \tikzstyle{kolicina}=[thick]
        \tikzstyle{zvezdica}=[pot]
        \tikzstyle{puscica}=[->]
}{
        \pgfkeysifdefined{/nicle}{\tikzstyle{povezava}=[prazna]}{}
        \ifthenelse{\equal{#2}{*}}{}{
            \begin{pretok@#2}
            \end{pretok@#2}
        }
    \end{tikzpicture}
}

\NewEnviron{pretok}[2][]{
    \bigskip
    \noindent
    \makebox[\textwidth][c]{
        \stevec{#2}
        \leavevmode\beginpgfgraphicnamed{pretok-#2-\arabic{#2}}
        \begin{pretok*}[#1]{#2}
            \BODY
        \end{pretok*}
        \endpgfgraphicnamed
    }
}{}

\NewDocumentEnvironment{neusmerjen*}{O{{}}m}{
    \begin{tikzpicture}[velikost,#1]
    \tikzstyle{every node}=[]
    \tikzstyle{vertex}=[draw, circle, fill=white, inner sep=0pt, vozlisce neusmerjenega grafa]
    \tikzstyle{zacetek}=[zacetek neusmerjenega grafa]
    \tikzstyle{konec}=[konec neusmerjenega grafa]
    \tikzstyle{zasicena}=[dashed]
    \tikzstyle{povezava}=[osnova]
    \tikzstyle{kolicina}=[thick]
    \tikzstyle{zvezdica}=[pot]
    \tikzstyle{puscica}=[]
}{
    \ifthenelse{\equal{#2}{*}}{}{
        \begin{neusmerjen@#2}
        \end{neusmerjen@#2}
    }
    \end{tikzpicture}
}

\NewEnviron{neusmerjen}[2][]{
    \bigskip
    \noindent
    \makebox[\textwidth][c]{
        \stevec{#2}
        \leavevmode\beginpgfgraphicnamed{neusmerjen-#2-\arabic{#2}}
        \begin{neusmerjen*}[#1]{#2}
            \BODY
        \end{neusmerjen*}
        \endpgfgraphicnamed
    }
}{}

\NewDocumentCommand{\izpisiOznako}{m}{
    \ifthenelse{\equal{#1}{l}}{\ell}{#1}
}

\NewDocumentCommand{\vozlisce}{smO{below}mO{}}{
    \pgfkeysifdefined{/nodes/#2}{\tikzset{/nodes/#2/.style={\pgfkeysvalueof{/nodes/#2}}}}{\tikzset{/nodes/#2/.style={}}}
    \node[vertex,
          label=#3:$\pgfkeysvalueof{/labels/#2}$,
          /nodes/#2] (#2) at (#4)
    {\ifthenelse{\IfBooleanTF{#1}{\equal{}{}}{\pgfkeysifdefined{/mreza}{\equal{0}{1}}{\boolean{@oznake}}}}{$\izpisiOznako{#2}$\ifthenelse{\equal{#5}{}}{}{:\,}}{}\pgfkeysifdefined{/mreza}{}{$#5$}};
}

\NewDocumentCommand{\povezava}{mmO{}mO{}mO{}}{
    \pgfkeysifdefined{/links/#1/#2}{}{\tikzset{/links/#1/#2/.style={}}}
    \pgfkeysifdefined{/start/#1/#2}{}{\pgfkeyssetvalue{/start/#1/#2}{#4}}
    \draw[puscica,povezava,/links/#1/#2] (#1) to[#7]
        node[zacetek, #6, #5] {\pgfkeysifdefined{/mreza}{}{$\pgfkeysvalueof{/start/#1/#2}$}}
        node[konec, #6, #5] {\pgfkeysifdefined{/mreza}{}{$\pgfkeysifdefined{/end/#1/#2}{\pgfkeysvalueof{/end/#1/#2}}{\pgfkeysifdefined{/nicle}{0}{}} \ifthenelse{\equal{#3}{}}{}{\le #3}$}}
        (#2);
}

\NewDocumentCommand{\nicle}{}{\pgfkeyssetvalue{/nicle}{}}

\NewDocumentCommand{\oznaka}{mm}{\pgfkeyssetvalue{/labels/#1}{#2}}

\NewDocumentCommand{\dosezeno}{mO{dosezeno}}{\pgfkeyssetvalue{/nodes/#1}{#2}}

\NewDocumentCommand{\cena}{mmm}{\pgfkeyssetvalue{/start/#1/#2}{#3}}

\NewDocumentCommand{\kolicina}{smmO{}mO{{}}}{
    \tikzset{/links/#2/#3/.style={\IfBooleanTF{#1}{zvezdica}{kolicina},#6}}
    \pgfkeyssetvalue{/links/#2/#3}{}
    \ifthenelse{\equal{#4}{}}{}{\pgfkeyssetvalue{/start/#2/#3}{#4}}
    \pgfkeyssetvalue{/end/#2/#3}{#5}
}

\NewDocumentCommand{\kandidat}{mmO{kandidat}}{
    \tikzset{/links/#1/#2/.style={#3}}
    \pgfkeyssetvalue{/links/#1/#2}{}
}

\NewDocumentCommand{\nasprotna}{mmO{nasprotna}}{
    \tikzset{/links/#1/#2/.style={#3}}
    \pgfkeyssetvalue{/links/#1/#2}{}
}

\NewEnviron{mreza}[3][0.3] {
    \stevec{mreza}%
    \@ifundefined{box@mreza}{%
        \newsavebox{\box@mreza}%
    }{}%
    \pgfkeyssetvalue{/mreza}{}%
    \tikzstyle{velikost}=[scale=#1]%
    \tikzstyle{velikost vozlisca razvoza}=[mreza/velikost vozlisca razvoza]%
    \tikzstyle{velikost vozlisca pretoka}=[mreza/velikost vozlisca pretoka]%
    \tikzstyle{velikost vozlisca neusmerjenega grafa}=[mreza/velikost vozlisca neusmerjenega grafa]%
    \tikzstyle{osnova}=[mreza/osnova]%
    \tikzstyle{zacetek razvoza}=[osnova, near start]%
    \savebox{\box@mreza}{
        \BODY
    }%
    \leavevmode\beginpgfgraphicnamed{mreza-\arabic{mreza}}%
    \begin{tikzpicture}[style=thick,scale=0.6]
        \let\matrix@mreza\empty
        \foreach \x in {1,...,#2} {
            \ifthenelse{#3>1}{
                \foreach \y in {2,...,#3} {
                    \expandafter\gappto\expandafter\matrix@mreza\expandafter{\usebox{\box@mreza} \&}
                }
            }{}
            \expandafter\gappto\expandafter\matrix@mreza\expandafter{\usebox{\box@mreza} \\}
        }
        \node[matrix of nodes,ampersand replacement=\&] {
            \matrix@mreza
        };
    \end{tikzpicture}
    \endpgfgraphicnamed
}

\endinput
